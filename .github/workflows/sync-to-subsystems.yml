# å·¥ä½œæµåç§°
name: Sync to Subsystems

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches:
      - main
    # å¯é€‰ï¼šåªç›‘å¬ç‰¹å®šè·¯å¾„çš„å˜åŒ–ï¼Œå‡å°‘ä¸å¿…è¦çš„è§¦å‘
    # å¦‚æœå¯ç”¨ï¼Œåªæœ‰è¿™äº›è·¯å¾„çš„æ–‡ä»¶å˜åŒ–æ‰ä¼šè§¦å‘å·¥ä½œæµ
    # paths:
    #   - 'src/components/UploadComponent/**'
    #   - '.github/workflows/sync-to-subsystems.yml'

  # å¯é€‰ï¼šæ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼ˆåœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œï¼‰
  workflow_dispatch:
    inputs:
      skip_sync:
        description: 'æ˜¯å¦è·³è¿‡åŒæ­¥ï¼ˆè¾“å…¥ true è·³è¿‡ï¼‰'
        required: false
        default: false
        type: boolean

# å·¥ä½œæµä»»åŠ¡
jobs:
  sync:
    runs-on: ubuntu-latest

    # æ§åˆ¶ 1: æ£€æŸ¥æäº¤æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å« [skip ci] æˆ– [skip sync]
    # å¦‚æœæäº¤æ¶ˆæ¯åŒ…å«è¿™äº›æ ‡è®°ï¼Œå·¥ä½œæµä¼šè·³è¿‡æ‰§è¡Œ
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[skip sync]') &&
      !contains(github.event.head_commit.message, '[ci skip]') &&
      (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_sync != 'true' || github.event_name != 'workflow_dispatch')

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´çš„ Git å†å²è®°å½•ï¼Œç”¨äºä¿ç•™æäº¤å†å²
          fetch-depth: 0
          # ä½¿ç”¨ token è¿›è¡Œè®¤è¯ï¼ˆGitHub è‡ªåŠ¨æä¾›ï¼Œæ— éœ€é…ç½®ï¼‰
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤ 2: é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºæäº¤è®°å½•ï¼‰
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # æ­¥éª¤ 3: åŒæ­¥åˆ°å„ä¸ªå­ç³»ç»Ÿ
      # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨å¾ªç¯æ–¹å¼å¤„ç†å¤šä¸ªç›®æ ‡ä»“åº“
      # å¦‚æœéœ€è¦å¹¶è¡Œæ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨ matrix ç­–ç•¥
      - name: Sync to Subsystems
        env:
          # ============================================
          # é…ç½®åŒºåŸŸï¼šè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ä»¥ä¸‹é…ç½®
          # ============================================

          # é…ç½® 1: è¦æ¨é€çš„æºç›®å½•è·¯å¾„ï¼ˆç›¸å¯¹äºä»“åº“æ ¹ç›®å½•ï¼‰
          # ç¤ºä¾‹ï¼šåªæ¨é€ UploadComponent ç»„ä»¶ç›®å½•
          SOURCE_DIR: 'src/components/UploadComponent'

          # é…ç½® 2: ç›®æ ‡åˆ†æ”¯åç§°ï¼ˆæ¨é€åˆ°å­ç³»ç»Ÿçš„å“ªä¸ªåˆ†æ”¯ï¼‰
          TARGET_BRANCH: 'dev'

          # é…ç½® 3: æºåˆ†æ”¯åç§°ï¼ˆä»å½“å‰ä»“åº“çš„å“ªä¸ªåˆ†æ”¯è·å–ä»£ç ï¼‰
          SOURCE_BRANCH: 'main'

          # é…ç½® 4: ç›®æ ‡ä»“åº“åˆ—è¡¨ï¼ˆå¤šä¸ªå­ç³»ç»Ÿåœ°å€ï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼‰
          # æ ¼å¼ï¼šhttps://github.com/owner/repo1 https://github.com/owner/repo2
          # æ³¨æ„ï¼šå¦‚æœä»“åº“æ˜¯ç§æœ‰çš„ï¼Œéœ€è¦ç¡®ä¿æœ‰è®¿é—®æƒé™
          # ç¤ºä¾‹ï¼ˆè¯·æ›¿æ¢ä¸ºå®é™…çš„ç›®æ ‡ä»“åº“åœ°å€ï¼‰ï¼š
          TARGET_REPOS: |
            https://github.com/your-org/subsystem1.git
            https://github.com/your-org/subsystem2.git
            https://github.com/your-org/subsystem3.git

          # é…ç½® 5: ç›®æ ‡ä»“åº“ä¸­çš„ç›®æ ‡ç›®å½•è·¯å¾„ï¼ˆä»£ç æ¨é€åˆ°å­ç³»ç»Ÿçš„å“ªä¸ªç›®å½•ï¼‰
          # å¦‚æœä¸ºç©ºï¼Œåˆ™æ¨é€åˆ°ä»“åº“æ ¹ç›®å½•
          # ç¤ºä¾‹ï¼šå¦‚æœè¦åœ¨å­ç³»ç»Ÿä¸­ä¹Ÿæ”¾åœ¨ç›¸åŒè·¯å¾„ï¼Œè®¾ç½®ä¸º 'src/components/UploadComponent'
          TARGET_DIR: 'src/components/UploadComponent'

          # é…ç½® 6: Git è®¤è¯ Tokenï¼ˆå¦‚æœéœ€è¦è®¿é—®ç§æœ‰ä»“åº“ï¼Œä½¿ç”¨ Personal Access Tokenï¼‰
          # åˆ›å»ºæ–¹å¼ï¼šGitHub Settings -> Developer settings -> Personal access tokens -> Tokens (classic)
          # æƒé™éœ€è¦ï¼šrepoï¼ˆå®Œæ•´ä»“åº“è®¿é—®æƒé™ï¼‰
          # ç„¶ååœ¨ä»“åº“ Settings -> Secrets and variables -> Actions ä¸­æ·»åŠ åä¸º GITHUB_TOKEN çš„ secret
          # æ³¨æ„ï¼šå¦‚æœæ‰€æœ‰ä»“åº“éƒ½æ˜¯å…¬å¼€çš„ï¼Œä¸”åœ¨åŒä¸€ç»„ç»‡ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨é»˜è®¤çš„ GITHUB_TOKEN
          GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # é…ç½® 7: GitHub Actions ä¸Šä¸‹æ–‡å˜é‡ï¼ˆç”¨äºæäº¤ä¿¡æ¯ï¼‰
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}

          # é…ç½® 8: å·¥ä½œæµå¼€å…³ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼‰
          # è®¾ç½®ä¸º 'false' å¯ä»¥ç¦ç”¨åŒæ­¥åŠŸèƒ½ï¼ˆå·¥ä½œæµä»ä¼šè¿è¡Œï¼Œä½†ä¼šè·³è¿‡åŒæ­¥æ­¥éª¤ï¼‰
          # å¯ä»¥é€šè¿‡ä»“åº“ Secrets è®¾ç½® ENABLE_SYNC æ¥æ§åˆ¶
          # åœ¨ä»“åº“ Settings -> Secrets and variables -> Actions -> New repository secret
          # æ·»åŠ åä¸º ENABLE_SYNC çš„ secretï¼Œå€¼ä¸º 'false' å³å¯ç¦ç”¨åŒæ­¥
          ENABLE_SYNC: ${{ secrets.ENABLE_SYNC || 'true' }}

        run: |
          echo "============================================"
          echo "å¼€å§‹åŒæ­¥ä»£ç åˆ°å­ç³»ç»Ÿ"
          echo "============================================"
          echo "æºç›®å½•: $SOURCE_DIR"
          echo "æºåˆ†æ”¯: $SOURCE_BRANCH"
          echo "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
          echo "ç›®æ ‡ç›®å½•: ${TARGET_DIR:-æ ¹ç›®å½•}"
          echo "åŒæ­¥å¼€å…³: $ENABLE_SYNC"
          echo ""

          # æ§åˆ¶ 2: æ£€æŸ¥åŒæ­¥å¼€å…³
          if [ "$ENABLE_SYNC" = "false" ]; then
            echo "âš ï¸  åŒæ­¥åŠŸèƒ½å·²ç¦ç”¨ï¼ˆENABLE_SYNC=falseï¼‰ï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi

          # æ£€æŸ¥æºç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$SOURCE_DIR" ]; then
            echo "âŒ é”™è¯¯: æºç›®å½• $SOURCE_DIR ä¸å­˜åœ¨"
            exit 1
          fi

          # éå†æ¯ä¸ªç›®æ ‡ä»“åº“
          echo "$TARGET_REPOS" | while read -r repo; do
            # è·³è¿‡ç©ºè¡Œ
            [ -z "$repo" ] && continue

            echo ""
            echo "--------------------------------------------"
            echo "æ­£åœ¨åŒæ­¥åˆ°: $repo"
            echo "--------------------------------------------"

            # æå–ä»“åº“åç§°ï¼ˆç”¨äºä¸´æ—¶ç›®å½•å‘½åï¼‰
            repo_name=$(basename "$repo" .git)
            temp_dir="temp_${repo_name}_$(date +%s)"

            # å…‹éš†ç›®æ ‡ä»“åº“åˆ°ä¸´æ—¶ç›®å½•
            echo "ğŸ“¥ å…‹éš†ç›®æ ‡ä»“åº“..."
            git clone --branch "$TARGET_BRANCH" --single-branch --depth 1 "$repo" "$temp_dir" 2>&1 || {
              # å¦‚æœç›®æ ‡åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º
              echo "âš ï¸  ç›®æ ‡åˆ†æ”¯ $TARGET_BRANCH ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º..."
              git clone --single-branch --depth 1 "$repo" "$temp_dir" 2>&1 || {
                echo "âŒ æ— æ³•å…‹éš†ä»“åº“ï¼Œè·³è¿‡: $repo"
                continue
              }
              cd "$temp_dir"
              git checkout -b "$TARGET_BRANCH" 2>&1 || git checkout "$TARGET_BRANCH" 2>&1
              cd ..
            }

            # è¿›å…¥ä¸´æ—¶ç›®å½•
            cd "$temp_dir"

            # é…ç½®è¿œç¨‹ä»“åº“ URLï¼ˆåŒ…å«è®¤è¯ä¿¡æ¯ï¼‰
            # å¦‚æœä½¿ç”¨ Personal Access Tokenï¼Œæ ¼å¼ä¸ºï¼šhttps://TOKEN@github.com/owner/repo.git
            if [ -n "$GIT_TOKEN" ] && [ "$GIT_TOKEN" != "null" ]; then
              # æå–ä»“åº“è·¯å¾„ï¼ˆå»æ‰ https:// å’Œ .gitï¼‰
              repo_path=$(echo "$repo" | sed 's|https://||' | sed 's|\.git$||')
              auth_repo="https://${GIT_TOKEN}@${repo_path}.git"
              git remote set-url origin "$auth_repo"
            fi

            # è·å–æºä»“åº“çš„æœ€æ–°æäº¤ä¿¡æ¯ï¼ˆç”¨äºä¿ç•™æäº¤å†å²è®°å½•ï¼‰
            echo "ğŸ“‹ è·å–æºä»“åº“æäº¤ä¿¡æ¯..."
            cd ..
            source_commit_hash=$(git rev-parse HEAD)
            source_commit_message=$(git log -1 --pretty=format:"%s")
            source_commit_author=$(git log -1 --pretty=format:"%an <%ae>")
            source_commit_date=$(git log -1 --pretty=format:"%ai")
            cd "$temp_dir"

            # åˆ›å»ºæˆ–æ¸…ç©ºç›®æ ‡ç›®å½•
            if [ -n "$TARGET_DIR" ]; then
              echo "ğŸ“ å‡†å¤‡ç›®æ ‡ç›®å½•: $TARGET_DIR"
              # åˆ é™¤ç›®æ ‡ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰- å¼ºåˆ¶è¦†ç›–æ¨¡å¼
              rm -rf "$TARGET_DIR"
              # åˆ›å»ºç›®å½•ç»“æ„
              mkdir -p "$TARGET_DIR"
            else
              # å¦‚æœç›®æ ‡ç›®å½•ä¸ºç©ºï¼Œæ¸…ç©ºæ ¹ç›®å½•ï¼ˆä¿ç•™ .gitï¼‰
              echo "ğŸ“ å‡†å¤‡æ ¹ç›®å½•ï¼ˆå¼ºåˆ¶è¦†ç›–æ¨¡å¼ï¼‰"
              find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
            fi

            # å¤åˆ¶æºç›®å½•å†…å®¹åˆ°ç›®æ ‡ç›®å½•
            echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶ï¼ˆä¿ç•™æ–‡ä»¶ç»“æ„ï¼‰..."
            if [ -n "$TARGET_DIR" ]; then
              cp -r "../$SOURCE_DIR"/* "$TARGET_DIR/" 2>/dev/null || {
                # å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œå°è¯•é€ä¸ªæ–‡ä»¶å¤åˆ¶ï¼ˆåŒ…æ‹¬éšè—æ–‡ä»¶ï¼‰
                mkdir -p "$TARGET_DIR"
                cp -r "../$SOURCE_DIR"/. "$TARGET_DIR/" 2>/dev/null || true
              }
            else
              cp -r "../$SOURCE_DIR"/* . 2>/dev/null || {
                cp -r "../$SOURCE_DIR"/. . 2>/dev/null || true
              }
            fi

            # æ·»åŠ æ‰€æœ‰æ›´æ”¹
            git add -A

            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
            if git diff --staged --quiet && git diff --quiet; then
              echo "â„¹ï¸  æ²¡æœ‰æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
              cd ..
              rm -rf "$temp_dir"
              continue
            fi

            # æäº¤æ›´æ”¹ï¼ˆå¼ºåˆ¶è¦†ç›–æ¨¡å¼ï¼‰
            # æäº¤ä¿¡æ¯åŒ…å«æºä»“åº“çš„å®Œæ•´æäº¤å†å²ä¿¡æ¯ï¼Œä¾¿äºè¿½æº¯
            echo "ğŸ’¾ æäº¤æ›´æ”¹ï¼ˆä¿ç•™æºä»“åº“æäº¤ä¿¡æ¯ï¼‰..."
            # æ„å»ºæäº¤æ¶ˆæ¯ï¼ˆä½¿ç”¨ printf é¿å… YAML è§£æé—®é¢˜ï¼‰
            commit_title="chore: sync from main repository [skip ci]"
            commit_body=$(printf "Auto-synced from %s@%s\nSource branch: %s\nSource directory: %s\nSource commit: %s\nSource commit message: %s\nSource commit author: %s\nSource commit date: %s\nSynced at: %s\n\nNote: This is an automated sync. Original commit history is preserved in the commit message above." \
              "${GITHUB_REPOSITORY}" \
              "${GITHUB_SHA}" \
              "$SOURCE_BRANCH" \
              "$SOURCE_DIR" \
              "$source_commit_hash" \
              "$source_commit_message" \
              "$source_commit_author" \
              "$source_commit_date" \
              "$(date -u +'%Y-%m-%d %H:%M:%S UTC')")
            commit_message="$commit_title"$'\n\n'"$commit_body"

            git commit -m "$commit_message" || {
              echo "âš ï¸  æäº¤å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰æ›´æ”¹"
            }

            # å¼ºåˆ¶æ¨é€åˆ°ç›®æ ‡ä»“åº“ï¼ˆè¦†ç›–è¿œç¨‹åˆ†æ”¯ï¼‰
            echo "ğŸš€ å¼ºåˆ¶æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
            git push origin "$TARGET_BRANCH" --force || {
              echo "âŒ æ¨é€å¤±è´¥: $repo"
              cd ..
              rm -rf "$temp_dir"
              continue
            }

            echo "âœ… æˆåŠŸåŒæ­¥åˆ°: $repo"

            # è¿”å›ä¸Šçº§ç›®å½•å¹¶æ¸…ç†ä¸´æ—¶ç›®å½•
            cd ..
            rm -rf "$temp_dir"
          done

          echo ""
          echo "============================================"
          echo "âœ… æ‰€æœ‰å­ç³»ç»ŸåŒæ­¥å®Œæˆ"
          echo "============================================"

      # æ­¥éª¤ 4: å¯é€‰ - å‘é€é€šçŸ¥ï¼ˆå¦‚éœ€è¦ï¼‰
      # - name: Notify on success
      #   if: success()
      #   run: |
      #     echo "åŒæ­¥æˆåŠŸé€šçŸ¥é€»è¾‘ï¼ˆå¯é›†æˆ Slackã€é‚®ä»¶ç­‰ï¼‰"

      # - name: Notify on failure
      #   if: failure()
      #   run: |
      #     echo "åŒæ­¥å¤±è´¥é€šçŸ¥é€»è¾‘"
